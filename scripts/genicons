#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd -- "$(dirname -- "$(readlink -f -- "${BASH_SOURCE[0]}")")" && pwd)"
cd "${SCRIPT_DIR}/.."

ASSETS_DIR="XCodeWrapper/Assets.xcassets/AppIcon.appiconset"
WATCH_ASSETS_DIR="XCodeWrapper/WatchAssets.xcassets/AppIcon.appiconset"
TV_ASSETS_DIR="XCodeWrapper/TVAssets.xcassets/App Icon.brandassets"
ORIG_ICON="extern/assets/icons/app_icon_orig.png"
MAC_MASK="extern/assets/icons/macos_icon_mask.png"

if [ ! -f $ORIG_ICON ]; then
    echo "Error: app_icon_orig.png not found in project"
    exit 1
fi

if ! command -v magick &> /dev/null; then
    echo "Error: ImageMagick not found. Install with: brew install imagemagick"
    exit 1
fi

echo "Generating app icons from app_icon_orig.png..."

SRGB_PROFILE="/System/Library/ColorSync/Profiles/sRGB Profile.icc"

magick "${ORIG_ICON}" -resize 1024x1024 -colorspace sRGB -profile "${SRGB_PROFILE}" "${ASSETS_DIR}/icon_1024x1024.png"
magick "${ORIG_ICON}" -resize 1024x1024 -colorspace sRGB -profile "${SRGB_PROFILE}" "${WATCH_ASSETS_DIR}/icon_1024x1024.png"

if [ ! -f "${MAC_MASK}" ]; then
    echo "Error: macOS app icon mask not found at ${MAC_MASK}"
    exit 1
fi

mkdir -p tmp

generate_mac_icon() {
    local canvas_size=$1
    local output_file=$2
    local icon_size=$(echo "$canvas_size * 824 / 1024" | bc)

    local tmp_resized="tmp/mac_resized_${canvas_size}.png"
    local tmp_mask="tmp/mac_mask_${canvas_size}.png"
    local tmp_masked="tmp/mac_masked_${canvas_size}.png"

    magick "${ORIG_ICON}" -resize ${icon_size}x${icon_size} -colorspace sRGB -profile "${SRGB_PROFILE}" "${tmp_resized}"
    magick "${MAC_MASK}" -resize ${icon_size}x${icon_size} "${tmp_mask}"
    magick "${tmp_resized}" \( "${tmp_mask}" -channel A -separate +channel \) -compose CopyOpacity -composite "${tmp_masked}"
    magick "${tmp_masked}" -gravity center -background none -extent ${canvas_size}x${canvas_size} "${output_file}"

    rm -f "${tmp_resized}" "${tmp_mask}" "${tmp_masked}"
}

generate_mac_icon 16 "${ASSETS_DIR}/icon_mac_16.png"
generate_mac_icon 32 "${ASSETS_DIR}/icon_mac_32.png"
generate_mac_icon 64 "${ASSETS_DIR}/icon_mac_64.png"
generate_mac_icon 128 "${ASSETS_DIR}/icon_mac_128.png"
generate_mac_icon 256 "${ASSETS_DIR}/icon_mac_256.png"
generate_mac_icon 512 "${ASSETS_DIR}/icon_mac_512.png"
generate_mac_icon 1024 "${ASSETS_DIR}/icon_mac_1024.png"

rm -f "${ASSETS_DIR}/icon_1024x1024_mac.png"

generate_tv_icon() {
    local width=$1
    local height=$2
    local output_file=$3
    magick "${ORIG_ICON}" -resize x${height} -gravity center -background 'srgb(40,40,40)' -extent ${width}x${height} -colorspace sRGB -profile "${SRGB_PROFILE}" -alpha off "${output_file}"
}

generate_tv_icon 400 240 "${TV_ASSETS_DIR}/App Icon.imagestack/Back.imagestacklayer/Content.imageset/back.png"
generate_tv_icon 800 480 "${TV_ASSETS_DIR}/App Icon.imagestack/Back.imagestacklayer/Content.imageset/back@2x.png"
generate_tv_icon 400 240 "${TV_ASSETS_DIR}/App Icon.imagestack/Front.imagestacklayer/Content.imageset/front.png"
generate_tv_icon 800 480 "${TV_ASSETS_DIR}/App Icon.imagestack/Front.imagestacklayer/Content.imageset/front@2x.png"
generate_tv_icon 1280 768 "${TV_ASSETS_DIR}/App Icon - App Store.imagestack/Back.imagestacklayer/Content.imageset/back_store.png"
generate_tv_icon 1280 768 "${TV_ASSETS_DIR}/App Icon - App Store.imagestack/Front.imagestacklayer/Content.imageset/front_store.png"

generate_tv_shelf() {
    local width=$1
    local height=$2
    local output_file=$3
    magick "${ORIG_ICON}" -resize x${height} -gravity center -background 'srgb(40,40,40)' -extent ${width}x${height} -colorspace sRGB -profile "${SRGB_PROFILE}" -alpha off "${output_file}"
}

generate_tv_shelf 1920 720 "${TV_ASSETS_DIR}/Top Shelf Image.imageset/shelf.png"
generate_tv_shelf 3840 1440 "${TV_ASSETS_DIR}/Top Shelf Image.imageset/shelf@2x.png"
generate_tv_shelf 2320 720 "${TV_ASSETS_DIR}/Top Shelf Image Wide.imageset/shelf_wide.png"
generate_tv_shelf 4640 1440 "${TV_ASSETS_DIR}/Top Shelf Image Wide.imageset/shelf_wide@2x.png"

echo "Generated all app icon sizes"

# sudo rm -rf /Library/Caches/com.apple.iconservices.store
